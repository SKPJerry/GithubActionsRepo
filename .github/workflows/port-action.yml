name: Port Self Service Execution

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "Repository name"
        required: true
        type: string
      visibility:
        description: "public"
        required: true
        type: boolean
      run_id:
        description: "Port action run identifier"
        required: false

jobs:
  run-port-action:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
      GH_PAT: ${{ secrets.ORG_ADMIN_TOKEN }} # PAT with permission to create repos

    steps:
      - name: Create repository
        id: create_repo
        shell: bash
        env:
          REPO_NAME: ${{ inputs.repo_name }}
          VISIBILITY: ${{ inputs.visibility }}
        run: |
          set -euo pipefail

          if [[ -z "${GH_PAT:-}" ]]; then
            echo "Secret ORG_ADMIN_TOKEN is not set"
            exit 1
          fi

          payload=$(jq -n \
            --arg name "$REPO_NAME" \
            --arg visibility "$VISIBILITY" \
            '{
              name: $name,
              visibility: $visibility,
              has_issues: true,
              has_projects: false,
              has_wiki: false,
              auto_init: true
            }')

          resp=$(curl -sS -X POST "$url" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "$payload")

          echo "$resp" | jq .

          html_url=$(echo "$resp" | jq -r '.html_url // empty')
          full_name=$(echo "$resp" | jq -r '.full_name // empty')
          if [[ -z "$html_url" || -z "$full_name" ]]; then
            echo "Repository creation failed"
            exit 1
          fi

          echo "repo_html_url=$html_url" >> "$GITHUB_OUTPUT"
          echo "repo_full_name=$full_name" >> "$GITHUB_OUTPUT"

      - name: Complete Port run (success)
        if: ${{ success() }}
        uses: port-labs/port-github-action@v1
        with:
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          status: SUCCESS
          link: ${{ steps.create_repo.outputs.repo_html_url }}
          message: Created repository ${{ steps.create_repo.outputs.repo_full_name }}

      - name: Complete Port run (failure)
        if: ${{ failure() }}
        uses: port-labs/port-github-action@v1
        with:
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          status: FAILURE
          message: "Repository creation failed. See workflow logs."
