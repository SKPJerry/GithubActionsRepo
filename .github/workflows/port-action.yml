name: Create Repository from Port

on:
  workflow_dispatch:
    inputs:
      run_id:
        required: true
      repo_name:
        required: true
      visibility:
        required: true
        default: "private"

jobs:
  create_repo_job:
    runs-on: ubuntu-latest
    env:
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
      GH_PAT: ${{ secrets.ORG_ADMIN_TOKEN }}   # Must be a PAT with repo creation rights

    steps:

      # 1️⃣ CREATE REPOSITORY
      - name: Create repository
        id: create
        run: |
          set -e

          # Map visibility to "private" boolean if creating under user
          PRIVATE_FLAG="true"
          if [ "${{ inputs.visibility }}" = "public" ]; then
            PRIVATE_FLAG="false"
          fi

          RESPONSE=$(curl -s -X POST https://api.github.com/user/repos \
            -H "Authorization: Bearer $GH_PAT" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"name\": \"${{ inputs.repo_name }}\", \"private\": $PRIVATE_FLAG, \"auto_init\": true}")

          echo "$RESPONSE"

          URL=$(echo "$RESPONSE" | jq -r '.html_url // empty')
          if [ -z "$URL" ]; then
            echo "Repository creation failed."
            exit 1
          fi

          echo "repo_url=$URL" >> $GITHUB_OUTPUT

      # 2️⃣ REPORT SUCCESS TO PORT
      - name: Report SUCCESS to Port
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          operation: PATCH_RUN
          status: SUCCESS
          runId: ${{ inputs.run_id }}
          link: ${{ steps.create.outputs.repo_url }}
          message: "Repository created: ${{ steps.create.outputs.repo_url }}"

      # 3️⃣ REPORT FAILURE TO PORT
      - name: Report FAILURE to Port
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          operation: PATCH_RUN
          status: FAILURE
          runId: ${{ inputs.run_id }}
          message: "Repository creation failed. Check workflow logs."
